{"version":3,"file":"ng-annotate-text-latest.min.js","sources":["ng-annotate-text.coffee"],"names":[],"mappings":"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","sourcesContent":["ngAnnotateText = angular.module \"ngAnnotateText\", []\n\nannotationIdCounter = 0\n\ninsertAt = (text, index, string)->\n\treturn text.substr(0, index) + string + text.substr(index)\n\nsortAnnotationsByEndIndex = (annotations)->\n\treturn annotations.sort (a, b)->\n\t\tif a.endIndex < b.endIndex\n\t\t\treturn -1\n\t\telse if a.endIndex > b.endIndex\n\t\t\treturn 1\n\t\treturn 0\n\nparseAnnotations = (text, annotations = [], indexOffset = 0)->\n\tif annotations.length is 0\n\t\treturn text\n\tannotations = sortAnnotationsByEndIndex annotations\n\n\tfor i in [annotations.length - 1..0] by -1\n\t\tannotation = annotations[i];\n\t\ttext = insertAt text, annotation.endIndex + indexOffset, \"</span>\"\n\t\tif annotation.children.length\n\t\t\ttext = parseAnnotations text, annotation.children, annotation.startIndex + indexOffset\n\t\ttext = insertAt text, annotation.startIndex + indexOffset, \"<span class=\\\"ng-annotate-text-annotation ng-annotate-text-\" + annotation.id + \" ng-annotate-text-type-\" + annotation.type + \"\\\" data-annotation-id=\\\"\" + annotation.id + \"\\\">\"\n\treturn text\n\ngetAnnotationById = (annotations, aId)->\n\tfor a in annotations\n\t\tif aId is a.id\n\t\t\treturn a\n\t\tif a.children.length > 0\n\t\t\tan = getAnnotationById a.children, aId\n\t\t\tif an isnt undefined\n\t\t\t\treturn an\n\nngAnnotateText.factory \"NGAnnotateTextPopup\", ->\n\t(args) ->\n\t\targs = angular.extend {\n\t\t\tscope: null,\n\t\t\tcallbacks: {},\n\t\t\ttemplate: \"<div/>\"\n\t\t\t$anchor: null\n\t\t\tpreferredAxis: 'x'\n\t\t\toffset: 0\n\t\t\tpositionClass: '{{position}}'\n\t\t}, args\n\n\t\tangular.extend @, args,\n\t\t\t$el: angular.element args.template\n\n\t\t\tshow: (speed = \"fast\") ->\n\t\t\t\t@$el.fadeIn speed\n\t\t\t\t@reposition()\n\t\t\t\tif typeof @callbacks.show is \"function\"\n\t\t\t\t\t@callbacks.show @$el\n\n\t\t\thide: (speed = \"fast\")->\n\t\t\t\t@$el.fadeOut speed\n\t\t\t\tif typeof @callbacks.hide is \"function\"\n\t\t\t\t\t@callbacks.hide @$el\n\n\t\t\tisVisible: ->\n\t\t\t\treturn @$el.is \":visible\"\n\n\t\t\tdestroy: (cb = angular.noop)->\n\t\t\t\tscope = @scope\n\t\t\t\t$el = @$el\n\t\t\t\t@hide ->\n\t\t\t\t\tif typeof cb is \"function\"\n\t\t\t\t\t\tcb()\n\t\t\t\t\tscope.$destroy()\n\t\t\t\t\t$el.remove()\n\n\t\t\tstopDestroy: ->\n\t\t\t\t@$el.stop(true).show(\"fast\")\n\n\t\t\treposition: ->\n\t\t\t\ttargetEl = @$el[0]\n\t\t\t\tanchorEl = @$anchor[0]\n\n\t\t\t\tif not (targetEl or anchorEl)\n\t\t\t\t\treturn\n\n\t\t\t\tpos =\n\t\t\t\t\tleft: null\n\t\t\t\t\ttop: null\n\t\t\t\t\ttarget: targetEl.getBoundingClientRect()\n\t\t\t\t\tanchor: anchorEl.getBoundingClientRect()\n\t\t\t\t\tviewport:\n\t\t\t\t\t\twidth: window.innerWidth\n\t\t\t\t\t\theight: window.innerHeight\n\t\t\t\t\tscroll:\n\t\t\t\t\t\ttop: document.body.scrollTop\n\t\t\t\t\t\tleft: document.body.scrollLeft\n\n\t\t\t\tif not (pos.target.width > 0 and pos.target.height > 0)\n\t\t\t\t\treturn\n\n\t\t\t\t# Find first axis position\n\n\t\t\t\tposX = @getNewPositionOnAxis pos, 'x'\n\t\t\t\tposY = @getNewPositionOnAxis pos, 'y'\n\n\t\t\t\tif @preferredAxis is 'x'\n\t\t\t\t\tif posX and typeof posX.pos is 'number'\n\t\t\t\t\t\tpos.left = posX.pos\n\t\t\t\t\t\tpos.edge = posX.edge\n\t\t\t\t\telse if posY\n\t\t\t\t\t\tpos.top = posY.pos\n\t\t\t\t\t\tpos.edge = posY.edge\n\t\t\t\telse\n\t\t\t\t\tif posY and typeof posY.pos is 'number'\n\t\t\t\t\t\tpos.top = posY.pos\n\t\t\t\t\t\tpos.edge = posY.edge\n\t\t\t\t\telse if posX\n\t\t\t\t\t\tpos.left = posX.pos\n\t\t\t\t\t\tpos.edge = posX.edge\n\n\t\t\t\t# Center on second axis\n\n\t\t\t\tif pos.left is null and pos.top is null\n\t\t\t\t\t# Center on X and Y axes\n\t\t\t\t\tpos.left = pos.scroll.left + (pos.viewport.width / 2) - (pos.target.width / 2)\n\t\t\t\t\tpos.top = pos.scroll.top + (pos.viewport.height / 2) - (pos.target.height / 2)\n\t\t\t\telse if pos.left is null\n\t\t\t\t\t# Center on X axis\n\t\t\t\t\tpos.left = @getNewCenterPositionOnAxis pos, 'x'\n\t\t\t\telse if pos.top is null\n\t\t\t\t\t# Center on Y axis\n\t\t\t\t\tpos.top = @getNewCenterPositionOnAxis pos, 'y'\n\n\t\t\t\t@$el\n\t\t\t\t\t.addClass pos.edge && @positionClass.replace \"{{position}}\", pos.edge\n\t\t\t\t\t.css\n\t\t\t\t\t\ttop: Math.round(pos.top) || 0\n\t\t\t\t\t\tleft: Math.round(pos.left) || 0\n\n\t\t\t\treturn\n\n\t\t\tgetNewPositionOnAxis: (pos, axis) ->\n\t\t\t\tstart = {x: 'left', y: 'top'}[axis]\n\t\t\t\tend = {x: 'right', y: 'bottom'}[axis]\n\t\t\t\tsize = {x: 'width', y: 'height'}[axis]\n\t\t\t\tif pos.anchor[start] - @offset >= pos.target[size]\n\t\t\t\t\taxisPos =\n\t\t\t\t\t\tpos: pos.scroll[start] + pos.anchor[start] - @offset - pos.target[size]\n\t\t\t\t\t\tedge: start\n\t\t\t\telse if pos.viewport[size] - pos.anchor[end] - @offset >= pos.target[size]\n\t\t\t\t\taxisPos =\n\t\t\t\t\t\tpos: pos.scroll[start] + pos.anchor[end] + @offset\n\t\t\t\t\t\tedge: end\n\t\t\t\taxisPos\n\n\t\t\tgetNewCenterPositionOnAxis: (pos, axis) ->\n\t\t\t\tstart = {x: 'left', y: 'top'}[axis]\n\t\t\t\tsize = {x: 'width', y: 'height'}[axis]\n\t\t\t\tcenterPos = pos.scroll[start] + pos.anchor[start] + (pos.anchor[size] / 2) - (pos.target[size] / 2)\n\t\t\t\tMath.max(pos.scroll[start] + @offset, Math.min(centerPos, pos.scroll[start] + pos.viewport[size] - pos.target[size] - @offset))\n\nngAnnotateText.factory \"NGAnnotation\", ->\n\tAnnotation = (data)->\n\n\t\tangular.extend @,\n\t\t\tid: annotationIdCounter++,\n\t\t\tstartIndex: null\n\t\t\tendIndex: null\n\t\t\tdata: {points: 0}\n\t\t\ttype: \"\"\n\t\t\tchildren: []\n\n\t\tif data?\n\t\t\tangular.extend @, data\n\n\treturn Annotation\n\nngAnnotateText.directive \"ngAnnotateText\", ($rootScope, $compile, $http, $q, $controller, $sce, NGAnnotation, NGAnnotateTextPopup)->\n\trestrict: \"E\"\n\tscope:\n\t\ttext: \"=\"\n\t\tannotations: \"=\"\n\t\treadonly: \"=\"\n\t\tpopupController: \"=\"\n\t\tpopupTemplateUrl: \"=\"\n\t\ttooltipController: \"=\"\n\t\ttooltipTemplateUrl: \"=\"\n\t\tonAnnotate: \"=\"\n\t\tonAnnotateDelete: \"=\"\n\t\tonAnnotateError: \"=\"\n\t\tonPopupShow: \"=\"\n\t\tonPopupHide: \"=\"\n\t\tpopupOffset: \"=\"\n\ttemplate: \"<p ng-bind-html=\\\"content\\\"></p>\"\n\treplace: true\n\n\tcompile: (el, attr) ->\n\t\tattr.readonly ?= false\n\t\t@postLink\n\n\tpostLink: ($scope, element, attrs) ->\n\t\tPOPUP_OFFSET = $scope.popupOffset ? 10\n\n\t\tactivePopup = null\n\t\tactiveTooltip = null\n\n\t\t# Cache the template when we fetch it\n\t\tpopupTemplateData = \"\"\n\t\ttooltipTemplateData = \"\"\n\n\t\tonAnnotationsChange = ->\n\t\t\tif not $scope.text? or !$scope.text.length\n\t\t\t\treturn\n\t\t\tt = parseAnnotations $scope.text, $scope.annotations\n\t\t\t$scope.content = $sce.trustAsHtml t\n\n\t\t# Annotation parsing\n\t\t$scope.$watch \"text\", onAnnotationsChange\n\t\t$scope.$watch \"annotations\", onAnnotationsChange, true\n\n\t\tclearPopup = ->\n\t\t\tif not activePopup?\n\t\t\t\treturn\n\t\t\ttId = activePopup.scope.$annotation.id\n\t\t\tactivePopup.destroy ->\n\t\t\t\tif activePopup.scope.$annotation.id is tId\n\t\t\t\t\tactivePopup = null\n\n\t\tclearTooltip = ->\n\t\t\ttooltip = activeTooltip\n\t\t\tif not tooltip?\n\t\t\t\treturn\n\t\t\ttooltip.destroy ->\n\t\t\t\tif activeTooltip is tooltip\n\t\t\t\t\tactiveTooltip = null\n\n\t\tclearPopups = ->\n\t\t\tclearPopup()\n\t\t\tclearTooltip()\n\n\t\t$scope.$on \"$destroy\", clearPopups\n\t\t$scope.$on \"ngAnnotateText.clearPopups\", clearPopups\n\n\t\tif $scope.popupTemplateUrl\n\t\t\t$http.get($scope.popupTemplateUrl).then (response)->\n\t\t\t\tpopupTemplateData = response.data\n\n\t\tif $scope.tooltipTemplateUrl\n\t\t\t$http.get($scope.tooltipTemplateUrl).then (response)->\n\t\t\t\ttooltipTemplateData = response.data\n\n\t\tremoveChildren = (annotation)->\n\t\t\tfor i in [annotation.children.length - 1..0] by -1\n\t\t\t\ta = annotation.children[i]\n\t\t\t\tremoveChildren a\n\t\t\t\ta.children.splice i, 1\n\n\t\tremoveAnnotation = (id, annotations)->\n\t\t\tfor a, i in annotations\n\t\t\t\tremoveAnnotation id, a.children\n\n\t\t\t\tif a.id is id\n\t\t\t\t\tremoveChildren a\n\t\t\t\t\tannotations.splice i, 1\n\t\t\t\t\treturn\n\n\t\tcreateAnnotation = ->\n\t\t\tannotation = new NGAnnotation()\n\t\t\tsel = window.getSelection()\n\n\t\t\tif sel.isCollapsed\n\t\t\t\tthrow new Error \"NG_ANNOTATE_TEXT_NO_TEXT_SELECTED\"\n\n\t\t\trange = sel.getRangeAt 0\n\n\t\t\tif range.startContainer isnt range.endContainer\n\t\t\t\tthrow new Error \"NG_ANNOTATE_TEXT_PARTIAL_NODE_SELECTED\"\n\n\t\t\tif range.startContainer.parentNode.nodeName is \"SPAN\" # Is a child annotation\n\t\t\t\tparentId = if (attrId = range.startContainer.parentNode.getAttribute(\"data-annotation-id\"))? then parseInt(attrId, 10)\n\t\t\t\tif parentId is undefined\n\t\t\t\t\tthrow new Error \"NG_ANNOTATE_TEXT_ILLEGAL_SELECTION\"\n\t\t\t\tparentAnnotation = getAnnotationById $scope.annotations, parentId\n\n\t\t\t\tannotationParentCollection = parentAnnotation.children\n\t\t\telse\n\t\t\t\tannotationParentCollection = $scope.annotations\n\n\t\t\t# Does this selection has any siblings?\n\t\t\tif annotationParentCollection.length\n\t\t\t\t# Yup, find the previous sibling\n\t\t\t\tprevSiblingSpan = range.startContainer.previousSibling\n\t\t\t\tif prevSiblingSpan?\n\t\t\t\t\tprevSiblingId = if (attrId = prevSiblingSpan.getAttribute(\"data-annotation-id\"))? then parseInt(attrId, 10)\n\t\t\t\t\tif not prevSiblingId?\n\t\t\t\t\t\tthrow new Error \"NG_ANNOTATE_TEXT_ILLEGAL_SELECTION\"\n\n\t\t\t\t\tprevAnnotation = getAnnotationById $scope.annotations, prevSiblingId\n\t\t\t\t\tannotation.startIndex = prevAnnotation.endIndex + range.startOffset\n\t\t\t\t\tannotation.endIndex = prevAnnotation.endIndex + range.endOffset\n\t\t\t\telse\n\t\t\t\t\t# Doesn't have a prev sibling, alrighty then\n\t\t\t\t\tannotation.startIndex = range.startOffset\n\t\t\t\t\tannotation.endIndex = range.endOffset\n\t\t\telse\n\t\t\t\t# Nope\n\t\t\t\tannotation.startIndex = range.startOffset\n\t\t\t\tannotation.endIndex = range.endOffset\n\n\t\t\tannotationParentCollection.push annotation\n\t\t\tclearSelection()\n\t\t\treturn annotation\n\n\t\tclearSelection = ->\n\t\t\tif document.selection\n\t\t\t\tdocument.selection.empty() # Internet Explorer\n\t\t\telse if window.getSelection and window.getSelection().empty\n\t\t\t\twindow.getSelection().empty() # Chrome\n\t\t\telse if window.getSelection and window.getSelection().removeAllRanges\n\t\t\t\twindow.getSelection().removeAllRanges() # Firefox\n\n\t\tonSelect = (event)->\n\t\t\tif popupTemplateData.length is 0\n\t\t\t\treturn\n\n\t\t\ttry\n\t\t\t\tannotation = createAnnotation()\n\t\t\t\t$scope.$apply()\n\t\t\t\t$span = element.find \".ng-annotate-text-\" + annotation.id\n\t\t\tcatch ex\n\t\t\t\tif $scope.onAnnotateError?\n\t\t\t\t\t$scope.onAnnotateError ex\n\n\t\t\t\treturn\n\n\t\t\tclearPopups()\n\n\t\t\tloadAnnotationPopup annotation, $span, true\n\n\t\tonClick = (event)->\n\t\t\tif popupTemplateData.length is 0\n\t\t\t\treturn\n\n\t\t\t$target = angular.element event.target\n\t\t\ttargetId = if (attrId = $target.attr(\"data-annotation-id\"))? then parseInt(attrId, 10)\n\n\t\t\tif not targetId?\n\t\t\t\treturn\n\n\t\t\tif activePopup? and activePopup.scope.$annotation.id is targetId\n\t\t\t\tclearPopup()\n\t\t\t\treturn\n\t\t\tannotation = getAnnotationById $scope.annotations, targetId\n\n\t\t\tclearPopups()\n\n\t\t\tloadAnnotationPopup annotation, $target, false\n\n\t\tonMouseEnter = (event)->\n\t\t\tif tooltipTemplateData.length is 0\n\t\t\t\treturn\n\n\t\t\tevent.stopPropagation()\n\t\t\t$target = angular.element event.target\n\t\t\ttargetId = if (attrId = $target.attr(\"data-annotation-id\"))? then parseInt(attrId, 10)\n\n\t\t\tif activeTooltip? and activeTooltip.scope.$annotation.id is targetId\n\t\t\t\tactiveTooltip.stopDestroy()\n\t\t\t\treturn\n\t\t\telse\n\t\t\t\tclearTooltip()\n\n\t\t\tif not targetId?\n\t\t\t\treturn\n\n\t\t\tannotation = getAnnotationById $scope.annotations, targetId\n\n\t\t\t# We don't want to show the tooltip if a popup with the annotation is open,\n\t\t\t# or if the tooltip has both no comment and points\n\t\t\tif activePopup? or (not annotation.data.comment and not annotation.data.points)\n\t\t\t\treturn\n\n\t\t\ttooltip = new NGAnnotateTextPopup\n\t\t\t\tscope: $rootScope.$new()\n\t\t\t\ttemplate: \"<div class='ng-annotate-text-tooltip' />\"\n\t\t\t\tpositionClass: \"ng-annotate-text-tooltip-docked ng-annotate-text-tooltip-docked-{{position}}\"\n\t\t\t\t$anchor: $target\n\t\t\t\tpreferredAxis: 'y'\n\t\t\t\toffset: POPUP_OFFSET\n\t\t\ttooltip.scope.$annotation = annotation\n\n\t\t\tactiveTooltip = tooltip\n\n\t\t\tlocals =\n\t\t\t\t$scope: tooltip.scope\n\t\t\t\t$template: tooltipTemplateData\n\n\t\t\ttooltip.$el.html locals.$template\n\t\t\ttooltip.$el.appendTo \"body\"\n\n\t\t\tif $scope.tooltipController\n\t\t\t\tcontroller = $controller $scope.tooltipController, locals\n\t\t\t\ttooltip.$el.data \"$ngControllerController\", controller\n\t\t\t\ttooltip.$el.children().data \"$ngControllerController\", controller\n\n\t\t\t$compile(tooltip.$el) tooltip.scope\n\t\t\ttooltip.scope.$apply()\n\t\t\ttooltip.show()\n\n\t\tonMouseLeave = (event)->\n\t\t\tevent.stopPropagation()\n\n\t\t\t$target = angular.element event.target\n\t\t\ttargetId = if (attrId = $target.attr(\"data-annotation-id\"))? then parseInt(attrId, 10)\n\n\t\t\tif not targetId?\n\t\t\t\treturn\n\n\t\t\tclearTooltip()\n\n\t\tloadAnnotationPopup = (annotation, anchor, isNew)->\n\t\t\tpopup = new NGAnnotateTextPopup\n\t\t\t\tscope: $rootScope.$new()\n\t\t\t\tcallbacks:\n\t\t\t\t\tshow: $scope.onPopupShow\n\t\t\t\t\thide: $scope.onPopupHide\n\t\t\t\ttemplate: \"<div class='ng-annotate-text-popup' />\"\n\t\t\t\tpositionClass: \"ng-annotate-text-popup-docked ng-annotate-text-popup-docked-{{position}}\"\n\t\t\t\t$anchor: anchor\n\t\t\t\toffset: POPUP_OFFSET\n\n\t\t\tpopup.scope.$isNew = isNew\n\t\t\tpopup.scope.$annotation = annotation\n\t\t\tpopup.scope.$readonly = $scope.readonly\n\n\t\t\tpopup.scope.$reject = ->\n\t\t\t\tremoveAnnotation annotation.id, $scope.annotations\n\n\t\t\t\tif $scope.onAnnotateDelete?\n\t\t\t\t\t$scope.onAnnotateDelete annotation\n\t\t\t\tclearPopup()\n\t\t\t\treturn\n\n\t\t\tpopup.scope.$close = ->\n\t\t\t\tif $scope.onAnnotate?\n\t\t\t\t\t$scope.onAnnotate popup.scope.$annotation\n\t\t\t\tclearPopup()\n\t\t\t\treturn\n\n\t\t\tactivePopup = popup\n\n\t\t\tlocals =\n\t\t\t\t$scope: popup.scope\n\t\t\t\t$template: popupTemplateData\n\n\t\t\tpopup.$el.html locals.$template\n\t\t\tpopup.$el.appendTo \"body\"\n\n\t\t\tif $scope.popupController\n\t\t\t\tcontroller = $controller $scope.popupController, locals\n\t\t\t\tpopup.$el.data \"$ngControllerController\", controller\n\t\t\t\tpopup.$el.children().data \"$ngControllerController\", controller\n\n\t\t\t$compile(popup.$el) popup.scope\n\t\t\tpopup.scope.$apply()\n\t\t\tpopup.show()\n\n\t\telement.on \"mouseenter\", \"span\", onMouseEnter\n\t\telement.on \"mouseleave\", \"span\", onMouseLeave\n\n\t\telement.on \"mouseup\", (event)->\n\t\t\t# We need to determine if the user actually selected something\n\t\t\t# or if he just clicked on an annotation\n\t\t\tselection = window.getSelection()\n\t\t\tif !selection.isCollapsed and !$scope.readonly\n\t\t\t\t# User has selected something\n\t\t\t\tonSelect event\n\t\t\telse if selection.isCollapsed and event.target.nodeName is \"SPAN\"\n\t\t\t\tonClick event\n\t\t\telse if selection.isCollapsed\n\t\t\t\tclearPopups()\n"],"sourceRoot":"/source/"}