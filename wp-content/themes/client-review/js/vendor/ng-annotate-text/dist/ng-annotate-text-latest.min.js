(function(){var annotationIdCounter,getAnnotationById,insertAt,ngAnnotateText,parseAnnotations,sortAnnotationsByEndIndex;ngAnnotateText=angular.module("ngAnnotateText",[]),annotationIdCounter=0,insertAt=function(text,index,string){return text.substr(0,index)+string+text.substr(index)},sortAnnotationsByEndIndex=function(annotations){return annotations.sort(function(a,b){return a.endIndex<b.endIndex?-1:a.endIndex>b.endIndex?1:0})},parseAnnotations=function(text,annotations,indexOffset){var annotation,i,_i,_ref;if(null==annotations&&(annotations=[]),null==indexOffset&&(indexOffset=0),0===annotations.length)return text;for(annotations=sortAnnotationsByEndIndex(annotations),i=_i=_ref=annotations.length-1;_i>=0;i=_i+=-1)annotation=annotations[i],text=insertAt(text,annotation.endIndex+indexOffset,"</span>"),annotation.children.length&&(text=parseAnnotations(text,annotation.children,annotation.startIndex+indexOffset)),text=insertAt(text,annotation.startIndex+indexOffset,'<span class="ng-annotate-text-annotation ng-annotate-text-'+annotation.id+" ng-annotate-text-type-"+annotation.type+'" data-annotation-id="'+annotation.id+'">');return text},getAnnotationById=function(annotations,aId){var a,an,_i,_len;for(_i=0,_len=annotations.length;_len>_i;_i++){if(a=annotations[_i],aId===a.id)return a;if(a.children.length>0&&(an=getAnnotationById(a.children,aId),void 0!==an))return an}},ngAnnotateText.factory("NGAnnotateTextPopup",function(){return function(args){return args=angular.extend({scope:null,callbacks:{},template:"<div/>",$anchor:null,preferredAxis:"x",offset:0,positionClass:"{{position}}"},args),angular.extend(this,args,{$el:angular.element(args.template),show:function(speed){return null==speed&&(speed="fast"),this.$el.fadeIn(speed),this.reposition(),"function"==typeof this.callbacks.show?this.callbacks.show(this.$el):void 0},hide:function(speed){return null==speed&&(speed="fast"),this.$el.fadeOut(speed),"function"==typeof this.callbacks.hide?this.callbacks.hide(this.$el):void 0},isVisible:function(){return this.$el.is(":visible")},destroy:function(cb){var $el,scope;return null==cb&&(cb=angular.noop),scope=this.scope,$el=this.$el,this.hide(function(){return"function"==typeof cb&&cb(),scope.$destroy(),$el.remove()})},stopDestroy:function(){return this.$el.stop(!0).show("fast")},reposition:function(){var anchorEl,pos,posX,posY,targetEl;targetEl=this.$el[0],anchorEl=this.$anchor[0],(targetEl||anchorEl)&&(pos={left:null,top:null,target:targetEl.getBoundingClientRect(),anchor:anchorEl.getBoundingClientRect(),viewport:{width:window.innerWidth,height:window.innerHeight},scroll:{top:document.body.scrollTop,left:document.body.scrollLeft}},pos.target.width>0&&pos.target.height>0&&(posX=this.getNewPositionOnAxis(pos,"x"),posY=this.getNewPositionOnAxis(pos,"y"),"x"===this.preferredAxis?posX&&"number"==typeof posX.pos?(pos.left=posX.pos,pos.edge=posX.edge):posY&&(pos.top=posY.pos,pos.edge=posY.edge):posY&&"number"==typeof posY.pos?(pos.top=posY.pos,pos.edge=posY.edge):posX&&(pos.left=posX.pos,pos.edge=posX.edge),null===pos.left&&null===pos.top?(pos.left=pos.scroll.left+pos.viewport.width/2-pos.target.width/2,pos.top=pos.scroll.top+pos.viewport.height/2-pos.target.height/2):null===pos.left?pos.left=this.getNewCenterPositionOnAxis(pos,"x"):null===pos.top&&(pos.top=this.getNewCenterPositionOnAxis(pos,"y")),this.$el.addClass(pos.edge&&this.positionClass.replace("{{position}}",pos.edge)).css({top:Math.round(pos.top)||0,left:Math.round(pos.left)||0})))},getNewPositionOnAxis:function(pos,axis){var axisPos,end,size,start;return start={x:"left",y:"top"}[axis],end={x:"right",y:"bottom"}[axis],size={x:"width",y:"height"}[axis],pos.anchor[start]-this.offset>=pos.target[size]?axisPos={pos:pos.scroll[start]+pos.anchor[start]-this.offset-pos.target[size],edge:start}:pos.viewport[size]-pos.anchor[end]-this.offset>=pos.target[size]&&(axisPos={pos:pos.scroll[start]+pos.anchor[end]+this.offset,edge:end}),axisPos},getNewCenterPositionOnAxis:function(pos,axis){var centerPos,size,start;return start={x:"left",y:"top"}[axis],size={x:"width",y:"height"}[axis],centerPos=pos.scroll[start]+pos.anchor[start]+pos.anchor[size]/2-pos.target[size]/2,Math.max(pos.scroll[start]+this.offset,Math.min(centerPos,pos.scroll[start]+pos.viewport[size]-pos.target[size]-this.offset))}})}}),ngAnnotateText.factory("NGAnnotation",function(){var Annotation;return Annotation=function(data){return angular.extend(this,{id:annotationIdCounter++,startIndex:null,endIndex:null,data:{points:0},type:"",children:[]}),null!=data?angular.extend(this,data):void 0}}),ngAnnotateText.directive("ngAnnotateText",function($rootScope,$compile,$http,$q,$controller,$sce,NGAnnotation,NGAnnotateTextPopup){return{restrict:"E",scope:{text:"=",annotations:"=",readonly:"=",popupController:"=",popupTemplateUrl:"=",tooltipController:"=",tooltipTemplateUrl:"=",onAnnotate:"=",onAnnotateDelete:"=",onAnnotateError:"=",onPopupShow:"=",onPopupHide:"=",popupOffset:"="},template:'<p ng-bind-html="content"></p>',replace:!0,compile:function(el,attr){return null==attr.readonly&&(attr.readonly=!1),this.postLink},postLink:function($scope,element){var POPUP_OFFSET,activePopup,activeTooltip,clearPopup,clearPopups,clearSelection,clearTooltip,createAnnotation,loadAnnotationPopup,onAnnotationsChange,onClick,onMouseEnter,onMouseLeave,onSelect,popupTemplateData,removeAnnotation,removeChildren,tooltipTemplateData,_ref;return POPUP_OFFSET=null!=(_ref=$scope.popupOffset)?_ref:10,activePopup=null,activeTooltip=null,popupTemplateData="",tooltipTemplateData="",onAnnotationsChange=function(){var t;if(null!=$scope.text&&$scope.text.length)return t=parseAnnotations($scope.text,$scope.annotations),$scope.content=$sce.trustAsHtml(t)},$scope.$watch("text",onAnnotationsChange),$scope.$watch("annotations",onAnnotationsChange,!0),clearPopup=function(){var tId;if(null!=activePopup)return tId=activePopup.scope.$annotation.id,activePopup.destroy(function(){return activePopup.scope.$annotation.id===tId?activePopup=null:void 0})},clearTooltip=function(){var tooltip;return tooltip=activeTooltip,null!=tooltip?tooltip.destroy(function(){return activeTooltip===tooltip?activeTooltip=null:void 0}):void 0},clearPopups=function(){return clearPopup(),clearTooltip()},$scope.$on("$destroy",clearPopups),$scope.$on("ngAnnotateText.clearPopups",clearPopups),$scope.popupTemplateUrl&&$http.get($scope.popupTemplateUrl).then(function(response){return popupTemplateData=response.data}),$scope.tooltipTemplateUrl&&$http.get($scope.tooltipTemplateUrl).then(function(response){return tooltipTemplateData=response.data}),removeChildren=function(annotation){var a,i,_i,_ref1,_results;for(_results=[],i=_i=_ref1=annotation.children.length-1;_i>=0;i=_i+=-1)a=annotation.children[i],removeChildren(a),_results.push(a.children.splice(i,1));return _results},removeAnnotation=function(id,annotations){var a,i,_i,_len;for(i=_i=0,_len=annotations.length;_len>_i;i=++_i)if(a=annotations[i],removeAnnotation(id,a.children),a.id===id)return removeChildren(a),void annotations.splice(i,1)},createAnnotation=function(){var annotation,annotationParentCollection,attrId,parentAnnotation,parentId,prevAnnotation,prevSiblingId,prevSiblingSpan,range,sel;if(annotation=new NGAnnotation,sel=window.getSelection(),sel.isCollapsed)throw new Error("NG_ANNOTATE_TEXT_NO_TEXT_SELECTED");if(range=sel.getRangeAt(0),range.startContainer!==range.endContainer)throw new Error("NG_ANNOTATE_TEXT_PARTIAL_NODE_SELECTED");if("SPAN"===range.startContainer.parentNode.nodeName){if(parentId=null!=(attrId=range.startContainer.parentNode.getAttribute("data-annotation-id"))?parseInt(attrId,10):void 0,void 0===parentId)throw new Error("NG_ANNOTATE_TEXT_ILLEGAL_SELECTION");parentAnnotation=getAnnotationById($scope.annotations,parentId),annotationParentCollection=parentAnnotation.children}else annotationParentCollection=$scope.annotations;if(annotationParentCollection.length)if(prevSiblingSpan=range.startContainer.previousSibling,null!=prevSiblingSpan){if(prevSiblingId=null!=(attrId=prevSiblingSpan.getAttribute("data-annotation-id"))?parseInt(attrId,10):void 0,null==prevSiblingId)throw new Error("NG_ANNOTATE_TEXT_ILLEGAL_SELECTION");prevAnnotation=getAnnotationById($scope.annotations,prevSiblingId),annotation.startIndex=prevAnnotation.endIndex+range.startOffset,annotation.endIndex=prevAnnotation.endIndex+range.endOffset}else annotation.startIndex=range.startOffset,annotation.endIndex=range.endOffset;else annotation.startIndex=range.startOffset,annotation.endIndex=range.endOffset;return annotationParentCollection.push(annotation),clearSelection(),annotation},clearSelection=function(){return document.selection?document.selection.empty():window.getSelection&&window.getSelection().empty?window.getSelection().empty():window.getSelection&&window.getSelection().removeAllRanges?window.getSelection().removeAllRanges():void 0},onSelect=function(){var $span,annotation,ex;if(0!==popupTemplateData.length){try{annotation=createAnnotation(),$scope.$apply(),$span=element.find(".ng-annotate-text-"+annotation.id)}catch(_error){return ex=_error,void(null!=$scope.onAnnotateError&&$scope.onAnnotateError(ex))}return clearPopups(),loadAnnotationPopup(annotation,$span,!0)}},onClick=function(event){var $target,annotation,attrId,targetId;if(0!==popupTemplateData.length&&($target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null!=targetId))return null!=activePopup&&activePopup.scope.$annotation.id===targetId?void clearPopup():(annotation=getAnnotationById($scope.annotations,targetId),clearPopups(),loadAnnotationPopup(annotation,$target,!1))},onMouseEnter=function(event){var $target,annotation,attrId,controller,locals,targetId,tooltip;if(0!==tooltipTemplateData.length){if(event.stopPropagation(),$target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null!=activeTooltip&&activeTooltip.scope.$annotation.id===targetId)return void activeTooltip.stopDestroy();if(clearTooltip(),null!=targetId&&(annotation=getAnnotationById($scope.annotations,targetId),null==activePopup&&(annotation.data.comment||annotation.data.points)))return tooltip=new NGAnnotateTextPopup({scope:$rootScope.$new(),template:"<div class='ng-annotate-text-tooltip' />",positionClass:"ng-annotate-text-tooltip-docked ng-annotate-text-tooltip-docked-{{position}}",$anchor:$target,preferredAxis:"y",offset:POPUP_OFFSET}),tooltip.scope.$annotation=annotation,activeTooltip=tooltip,locals={$scope:tooltip.scope,$template:tooltipTemplateData},tooltip.$el.html(locals.$template),tooltip.$el.appendTo("body"),$scope.tooltipController&&(controller=$controller($scope.tooltipController,locals),tooltip.$el.data("$ngControllerController",controller),tooltip.$el.children().data("$ngControllerController",controller)),$compile(tooltip.$el)(tooltip.scope),tooltip.scope.$apply(),tooltip.show()}},onMouseLeave=function(event){var $target,attrId,targetId;return event.stopPropagation(),$target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null!=targetId?clearTooltip():void 0},loadAnnotationPopup=function(annotation,anchor,isNew){var controller,locals,popup;return popup=new NGAnnotateTextPopup({scope:$rootScope.$new(),callbacks:{show:$scope.onPopupShow,hide:$scope.onPopupHide},template:"<div class='ng-annotate-text-popup' />",positionClass:"ng-annotate-text-popup-docked ng-annotate-text-popup-docked-{{position}}",$anchor:anchor,offset:POPUP_OFFSET}),popup.scope.$isNew=isNew,popup.scope.$annotation=annotation,popup.scope.$readonly=$scope.readonly,popup.scope.$reject=function(){removeAnnotation(annotation.id,$scope.annotations),null!=$scope.onAnnotateDelete&&$scope.onAnnotateDelete(annotation),clearPopup()},popup.scope.$close=function(){null!=$scope.onAnnotate&&$scope.onAnnotate(popup.scope.$annotation),clearPopup()},activePopup=popup,locals={$scope:popup.scope,$template:popupTemplateData},popup.$el.html(locals.$template),popup.$el.appendTo("body"),$scope.popupController&&(controller=$controller($scope.popupController,locals),popup.$el.data("$ngControllerController",controller),popup.$el.children().data("$ngControllerController",controller)),$compile(popup.$el)(popup.scope),popup.scope.$apply(),popup.show()},element.on("mouseenter","span",onMouseEnter),element.on("mouseleave","span",onMouseLeave),element.on("mouseup",function(event){var selection;return selection=window.getSelection(),selection.isCollapsed||$scope.readonly?selection.isCollapsed&&"SPAN"===event.target.nodeName?onClick(event):selection.isCollapsed?clearPopups():void 0:onSelect(event)})}}})}).call(this);
//# sourceMappingURL=ng-annotate-text-latest.min.js.map